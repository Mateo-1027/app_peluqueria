{% extends "base.html" %}

{% block title %}Mascotas - Peluquería Canina{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow p-6">
    <h1 class="text-2xl font-bold mb-4">Registro de Mascotas</h1>

    <form action="{{ url_for('main.add_dog') }}" method="POST" class="border-b pb-6 mb-6">
        {{ form.csrf_token }}

        <!-- Buscador de Dueño con Autocompletado -->
        <div class="mb-8">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Buscar Dueño Existente</label>
            <div class="relative">
                <input type="text" id="ownerSearchInput" placeholder="Escribe nombre o teléfono..."
                    class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition"
                    autocomplete="off" />

                <!-- Dropdown de sugerencias -->
                <div id="ownerSuggestions"
                    class="absolute z-10 w-full bg-white border rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
                    <!-- Las sugerencias se insertarán aquí dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Campos del formulario -->
        <div class="grid grid-cols-3 gap-4">
            <label class="block text-sm font-semibold text-gray-700">Añadir Dueño nuevo</label>
            <input type="text" id="dogName" name="name" placeholder="Nombre del perro" required
                class="col-span-3 p-2 rounded border" />

            <input type="text" id="ownerName" name="owner_name" placeholder="Nombre del dueño" required
                class="col-span-1 p-2 rounded border" />

            <input type="text" id="ownerPhone" name="owner_phone" placeholder="Teléfono"
                class="col-span-1 p-2 rounded border" />

            <input type="text" id="ownerAddress" name="address" placeholder="Dirección"
                class="col-span-1 p-2 rounded border" />

            <textarea id="dogNotes" name="notes" placeholder="Notas" class="col-span-3 border p-2 rounded"></textarea>

            <button type="submit" class="col-span-3 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                Agregar Perro
            </button>
        </div>
    </form>

    <div class="flex gap-2 mb-4">
        <div class="relative flex-1">
            <input type="text" id="searchInput" placeholder="Buscar por Nombre o Legajo ..."
                class="w-full p-2 pl-4 border rounded focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition"
                autocomplete="off" />
        </div>

        <button onclick="ejecutarBusqueda()"
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded transition shadow-sm">
            Buscar
        </button>

        <button onclick="resetearBusqueda()"
            class="px-4 py-2 bg-white hover:bg-gray-100 text-gray-600 font-medium rounded transition border border-gray-300"
            title="Limpiar búsqueda">
            Limpiar
        </button>
    </div>

    <div class="max-h-96 overflow-y-auto border rounded-lg bg-gray-50 p-2 min-h-[150px]">

        <div id="initialState" class="flex flex-col items-center justify-center h-32 text-gray-400">
            <p>Utilizá el buscador para encontrar una mascota</p>
        </div>

        <ul id="dogList" class="divide-y divide-gray-200 hidden">
        </ul>

        <div id="loadingMsg" class="hidden text-center py-8 text-gray-400">
            <span class="inline-block animate-spin mr-2">⟳</span> Buscando...
        </div>
        <div id="noResults" class="hidden text-center py-8 text-gray-500">
            No encontramos mascotas con esos datos.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. DEFINICIÓN DE VARIABLES (Fundamental para que no falle)
    const searchInput = document.getElementById('searchInput');
    const dogList = document.getElementById('dogList');
    const initialState = document.getElementById('initialState');
    const noResults = document.getElementById('noResults');
    const loadingMsg = document.getElementById('loadingMsg');

    // 2. DETECTAR ENTER EN EL INPUT
    searchInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Evita que se envíe el formulario de arriba por error
            ejecutarBusqueda();
        }
    });

    // 3. FUNCIÓN DE BÚSQUEDA (Con manejo de errores visuales)
    function ejecutarBusqueda() {
        const query = searchInput.value.trim();

        // Ocultamos todo para mostrar el spinner de carga
        if (initialState) initialState.classList.add('hidden');
        noResults.classList.add('hidden');
        dogList.classList.add('hidden');
        loadingMsg.classList.remove('hidden');

        fetch(`/api/dogs/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                renderizarLista(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexión con el servidor.');
            })
            .finally(() => {
                // Pase lo que pase, ocultamos el spinner
                loadingMsg.classList.add('hidden');
            });
    }

    // 4. FUNCIÓN LIMPIAR (Restaura el estado inicial)
    function resetearBusqueda() {
        searchInput.value = '';

        // Ocultamos resultados
        dogList.classList.add('hidden');
        dogList.innerHTML = '';
        noResults.classList.add('hidden');

        // Mostramos el cartel de bienvenida de nuevo
        if (initialState) initialState.classList.remove('hidden');

        // Ponemos el cursor en el input
        searchInput.focus();
    }

    // 5. RENDERIZADO DE LA LISTA
    function renderizarLista(dogs) {
        dogList.innerHTML = ''; // Limpiar lista vieja

        if (dogs.length === 0) {
            noResults.classList.remove('hidden');
            return;
        }

        // Si hay perros, mostramos la lista
        dogList.classList.remove('hidden');

        dogs.forEach(dog => {
            const viewUrl = `/dogs/${dog.id}`;
            const editUrl = `/dogs/edit/${dog.id}`;
            const deleteUrl = `/dogs/delete/${dog.id}`;

            const li = document.createElement('li');
            li.className = 'py-3 px-2 dog-item flex items-center justify-between hover:bg-white rounded transition border-b border-gray-100 last:border-0';

            li.innerHTML = `
                <a href="${viewUrl}" class="flex-1 hover:text-blue-600 group">
                    <div>
                        <strong class="text-gray-800 group-hover:text-blue-600">${dog.name}</strong> 
                        <span class="text-xs font-mono bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded ml-2 border border-blue-200">Legajo: ${dog.id}</span>
                    </div>
                    <span class="text-gray-500 text-sm">Dueño: ${dog.owner_name || 'No registrado'}</span>
                </a>
                <div class="flex gap-2 opacity-60 hover:opacity-100 transition-opacity">
                    <a href="${editUrl}" class="text-blue-600 hover:underline text-sm font-medium px-2 py-1 rounded hover:bg-blue-50">Editar</a>
                    <form action="${deleteUrl}" method="POST" onsubmit="return confirm('¿Eliminar esta mascota?')" class="inline">
                        <button type="submit" class="text-red-600 hover:underline text-sm font-medium px-2 py-1 rounded hover:bg-red-50">Eliminar</button>
                    </form>
                </div>
            `;
            dogList.appendChild(li);
        });
    }

    // ===== AUTOCOMPLETADO DE OWNERS =====

    const ownerSearchInput = document.getElementById('ownerSearchInput');
    const ownerSuggestions = document.getElementById('ownerSuggestions');
    const ownerNameField = document.getElementById('ownerName');
    const ownerPhoneField = document.getElementById('ownerPhone');
    const ownerAddressField = document.getElementById('ownerAddress');

    let selectedOwnerId = null;
    let debounceTimer = null;

    // Buscar owners mientras el usuario escribe
    ownerSearchInput.addEventListener('input', function () {
        const query = this.value.trim();

        // Limpiar el timer anterior
        clearTimeout(debounceTimer);

        if (query.length < 2) {
            ownerSuggestions.classList.add('hidden');
            return;
        }

        // Esperar 300ms antes de buscar (debounce)
        debounceTimer = setTimeout(() => {
            buscarOwners(query);
        }, 300);
    });

    function buscarOwners(query) {
        fetch(`/api/owners/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(owners => {
                mostrarSugerencias(owners);
            })
            .catch(error => {
                console.error('Error al buscar dueños:', error);
            });
    }

    function mostrarSugerencias(owners) {
        ownerSuggestions.innerHTML = '';

        if (owners.length === 0) {
            ownerSuggestions.innerHTML = `
                <div class="p-3 text-gray-500 text-sm text-center">
                    No se encontraron dueños. Puedes crear uno nuevo completando el formulario.
                </div>
            `;
            ownerSuggestions.classList.remove('hidden');
            return;
        }

        owners.forEach(owner => {
            const div = document.createElement('div');
            div.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b last:border-0 transition';
            div.innerHTML = `
                <div class="font-semibold text-gray-800">${owner.name}</div>
                <div class="text-sm text-gray-600">
                    ${owner.phone ? ' ' + owner.phone : 'Sin teléfono'}
                    ${owner.address ? ' • ' + owner.address : ''}
                </div>
            `;

            div.addEventListener('click', () => {
                seleccionarOwner(owner);
            });

            ownerSuggestions.appendChild(div);
        });

        ownerSuggestions.classList.remove('hidden');
    }

    function seleccionarOwner(owner) {
        // Autocompletar campos
        ownerNameField.value = owner.name;
        ownerPhoneField.value = owner.phone || '';
        ownerAddressField.value = owner.address || '';

        // Guardar el ID del owner seleccionado
        selectedOwnerId = owner.id;

        // Limpiar y ocultar sugerencias
        ownerSearchInput.value = owner.name;
        ownerSuggestions.classList.add('hidden');

        // Deshabilitar campos para evitar modificación accidental
        ownerNameField.setAttribute('readonly', true);
        ownerPhoneField.setAttribute('readonly', true);
        ownerAddressField.setAttribute('readonly', true);

        // Cambiar estilo visual para indicar que están bloqueados
        ownerNameField.classList.add('bg-gray-100');
        ownerPhoneField.classList.add('bg-gray-100');
        ownerAddressField.classList.add('bg-gray-100');

        // Mostrar botón para limpiar selección
        mostrarBotonLimpiar();
    }

    function mostrarBotonLimpiar() {
        // Buscar si ya existe el botón
        let btnLimpiar = document.getElementById('btnLimpiarOwner');

        if (!btnLimpiar) {
            btnLimpiar = document.createElement('button');
            btnLimpiar.id = 'btnLimpiarOwner';
            btnLimpiar.type = 'button';
            btnLimpiar.className = 'text-sm text-blue-600 hover:text-blue-800 underline mt-1';
            btnLimpiar.textContent = 'Limpiar y crear nuevo dueño';
            btnLimpiar.addEventListener('click', limpiarSeleccionOwner);

            // Insertar después del campo de búsqueda
            ownerSearchInput.parentElement.parentElement.appendChild(btnLimpiar);
        }
    }

    function limpiarSeleccionOwner() {
        // Limpiar campos
        ownerSearchInput.value = '';
        ownerNameField.value = '';
        ownerPhoneField.value = '';
        ownerAddressField.value = '';
        selectedOwnerId = null;

        // Habilitar campos
        ownerNameField.removeAttribute('readonly');
        ownerPhoneField.removeAttribute('readonly');
        ownerAddressField.removeAttribute('readonly');

        // Quitar estilo de bloqueado
        ownerNameField.classList.remove('bg-gray-100');
        ownerPhoneField.classList.remove('bg-gray-100');
        ownerAddressField.classList.remove('bg-gray-100');

        // Ocultar sugerencias
        ownerSuggestions.classList.add('hidden');

        // Remover botón limpiar
        const btnLimpiar = document.getElementById('btnLimpiarOwner');
        if (btnLimpiar) {
            btnLimpiar.remove();
        }

        // Focus en el campo de búsqueda
        ownerSearchInput.focus();
    }

    // Cerrar sugerencias al hacer clic fuera
    document.addEventListener('click', function (event) {
        if (!ownerSearchInput.contains(event.target) && !ownerSuggestions.contains(event.target)) {
            ownerSuggestions.classList.add('hidden');
        }
    });
</script>
{% endblock %}