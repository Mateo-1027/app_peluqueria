{% extends "base.html" %}

{% block title %}Detalles de {{dog.name}} - Peluqueria Canina{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow p-6">
  <h1 class="text-2xl font-bold mb-6">Detalles de {{dog.name}}</h1>

  <!-- Información del Perro -->
  <div class="bg-gray-50 rounded-lg p-4 mb-6">
    <h2 class="text-lg font-semibold mb-3 text-gray-700">Información General</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <span class="font-semibold text-gray-600">Nombre:</span>
        <span class="ml-2">{{dog.name}}</span>
      </div>
      <div>
        <span class="font-semibold text-gray-600">Dueño:</span>
        <span class="ml-2">{{dog.owner_name or 'No especificado'}}</span>
      </div>
      <div>
        <span class="font-semibold text-gray-600">Teléfono:</span>
        <span class="ml-2">{{dog.owner_phone or 'No especificado'}}</span>
      </div>
    </div>
    {% if dog.notes %}
    <div class="mt-3 pt-3 border-t border-gray-200">
      <span class="font-semibold text-gray-600">Notas:</span>
      <p class="mt-1 text-gray-700 whitespace-pre-wrap">{{dog.notes}}</p>
    </div>
    {% endif %}
  </div>

  <h2 class="text-xl font-semibold mt-6 mb-2">Turnos</h2>
  {% if appointments %}
  <ul class="divide-y divide-gray-200">
    {% for a in appointments %}
    <li class="py-3 flex items-center justify-between">
      <span>
        <strong>{{ a.start_time.strftime('%d/%m/%Y %H:%M') }}</strong> - {{ a.description }} (hasta {{
        a.end_time.strftime('%H:%M') }})
      </span>
      <div class="flex gap-2">
        <a href="{{ url_for('main.edit_appointment', appointment_id=a.id) }}"
          class="text-blue-600 hover:underline">Editar</a>
        <form action="{{ url_for('main.delete_appointment', appointment_id=a.id) }}" method="POST"
          onsubmit="return confirm('Eliminar este turno?')" class="inline">
          <button type="submit" class="text-red-600 hover:underline">Eliminar</button>
        </form>
      </div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="text-gray-500">Este perro no tiene turnos registrados.</p>
  {%endif%}

  <h2 class="text-xl font-semibold mt-6 mb-2">Historial Medico</h2>
  {% if notes %}
  <!-- Lista con scroll limitado -->
  <div class="max-h-72 overflow-y-auto border rounded-lg p-2 bg-gray-50">
    <ul class="divide-y divide-gray-200">
      {% for note in notes %}
      <li class="py-2 px-2 hover:bg-gray-100 cursor-pointer rounded transition"
        data-date="{{ note.date.strftime('%d/%m/%Y') }}" data-note="{{ note.note | default('', true) }}"
        onclick="openNoteModal(this.dataset.date, this.dataset.note)">
        <div class="flex items-center justify-between">
          <span class="font-medium text-blue-600">{{ note.date.strftime('%d/%m/%Y') }}</span>
          <span class="text-gray-400 text-sm">Clic para ver</span>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% else %}
  <p class="text-gray-500">No hay notas medicas.</p>
  {% endif %}

  <h3 class="text-lg font-semibold mt-6 mb-2">Agregar Nota Medica</h3>
  <form action="{{ url_for('main.add_note') }}" method="POST" class="space-y-3">
    <input type="hidden" name="dog_id" value="{{dog.id}}">
    <textarea name="note" placeholder="Detalle de la nota" required class="w-full p-2 border rounded"></textarea>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      Guardar Nota
    </button>
  </form>
</div>

<!-- Modal para ver nota completa -->
<div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
  onclick="closeNoteModal(event)">
  <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4 p-6" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold">Nota del <span id="modalDate"></span></h3>
      <button onclick="closeNoteModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <div class="bg-gray-50 p-4 rounded-lg max-h-80 overflow-y-auto">
      <p id="modalContent" class="text-gray-700 whitespace-pre-wrap"></p>
    </div>
    <button onclick="closeNoteModal()" class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
      Cerrar
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function openNoteModal(date, content) {
    document.getElementById('modalDate').textContent = date;
    document.getElementById('modalContent').textContent = content;
    document.getElementById('noteModal').classList.remove('hidden');
    document.getElementById('noteModal').classList.add('flex');
  }

  function closeNoteModal(event) {
    if (event && event.target !== document.getElementById('noteModal')) return;
    document.getElementById('noteModal').classList.add('hidden');
    document.getElementById('noteModal').classList.remove('flex');
  }

  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') closeNoteModal();
  });
</script>
{% endblock %}